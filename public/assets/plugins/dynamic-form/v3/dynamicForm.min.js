/*!
 * =============================================================
 *
 * Name: Dynamic Form 
 * 
 * Version : 3.0
 * 
 * author: Anandhan AS
 * 
 * Company: ProPlus Logics
 * 
 * Description : Add Dynamic form fields
 * 
 * (c) 2023 - ProPlus Logics<info@propluslogics.com> (https://propluslogics.com)
 * 
 * =============================================================
*/ !function(t){try{bootbox}catch(e){alert("Dynamic Form is required bootbox.js v4.4.0"),console.log("Dynamic Form is required bootbox.js v4.4.0")}t.fn.dynamicForm=function(e){let i=this,a={Version:"3.0",inputs:[],aligns:["left","center","right"],addButton:null,parentDiv:null,inputDiv:null,dialog:null,InputName:[],DeleteAIDs:[],Images:["png","jpeg","jpg","bmp","gif"],Documents:["pdf","doc","docx"]},n=t.extend({InputTypes:["text","number","date","url","file","email"],FileTypes:["Images","Documents"],ButtonClass:"btn btn-light",allowDuplicateNames:!1,inputDisable:!1,ButtonText:"Add More Fields",ButtonShow:!0,showDownloadButton:!1,RemoveButtonIcon:'<i class="fa fa-trash" aria-hidden="true"></i>',Data:null,fixedData:null,BaseUrl:"",FileTypesUrl:"",Columns:12,isValidate:!1,validateStatus:!0},e);function l(t){var e=document.getElementById(t),i=e.files[0],n=new FileReader;n.onloadend=function(){for(let i=0;i<a.inputs.length;i++)a.inputs[i].id==t&&(a.inputs[i].fileName=e.files[0].name,a.inputs[i].fileSize=e.files[0].size,a.inputs[i].fileType=e.files[0].type,a.inputs[i].value=n.result)},n.readAsDataURL(i)}return _getFileTypes=async()=>{""!=n.FileTypesUrl&&t.ajax({type:"post",url:n.FileTypesUrl,async:!1,headers:{"X-CSRF-Token":t("meta[name=_token]").attr("content")},success:function(e){t.each(e,function(t,e){void 0==a[t]&&(a[t]=[]),0>n.FileTypes.indexOf(t)&&(n.FileTypes[n.FileTypes.length]=t),a[t]=e})}})},is_AllDocuments=async e=>!!t.inArray(e,a.AllDocuments),is_Documents=async e=>!!t.inArray(e,a.Documents),is_PDF=async e=>!!t.inArray(e,a.PDF),is_Images=async e=>!!t.inArray(e,a.Images),is_Date=async t=>new Date(t)!="Invalid Date",is_Url=async t=>/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(t),is_Number=async e=>!!t.isNumeric(e),is_email=async t=>/^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(t),uniqid=async(t="",e=!1)=>{let i=Date.now()/1e3,a=i.toString(16).split(".").join("");for(;a.length<14;)a+="0";let n="",l=new Date,s=l.getDate()+(l.getMonth()+1)+l.getFullYear()+l.getHours()+l.getMinutes()+l.getSeconds()+l.getMilliseconds();return e&&(n=".",n+=Math.round(1e8*Math.random()*s)),t+a+n},_append=async(t,e)=>{e.append(t)},add_button=async e=>{if(!0==n.ButtonShow){let i=document.createElement("div"),a=document.createElement("div");i.setAttribute("class","row"),i.setAttribute("style","margin-top:20px"),a.setAttribute("class","col-12 col-sm-12 col-lg-12 d-flex justify-content-center");let l=document.createElement("button"),s=await uniqid("bt");l.setAttribute("id",s),l.setAttribute("type","button"),l.innerHTML=n.ButtonText,l.classList.add("addMoreFields"),l.style.textAlign="center",e.append(i),i.append(a),a.append(l),t("#"+s).addClass(n.ButtonClass)}},createDiv=async(e,i,a)=>{let n=document.createElement("div");return a.append(n),n.setAttribute("id",e),Array.isArray(i)?i.length>0&&t("#"+e).addClass(i.join(" ")):""!=i&&t("#"+e).addClass(i),n},add_input=async(e,i,l,s,u=null,d=null,r=0,p=0)=>{null==u&&(u=await uniqid("txt"));let o={id:u,name:e,ColName:e,isRequired:r,isFixed:p,value:"",type:i,dType:l,value:"",fileName:"",fileSize:"",fileType:""};null!=d&&void 0!=d&&(o.aid=d),a.inputs[a.inputs.length]=o;let c=await uniqid("div"),m=12;n.Columns<=12&&n.Columns>=1&&(m=Math.round(12/n.Columns));let $=document.createElement("div");await _append($,a.inputDiv),$.classList.add("col-sm-"+m),$.setAttribute("id",c),$.classList.add("inputRow");let F=document.createElement("div");await _append(F,$),F.classList.add("form-group");let f=document.createElement("label");await _append(f,F),f.setAttribute("for",u);let y="";1==r&&(y+=' <span class="required"> * </span>'),f.innerHTML=e+y;let g=document.createElement("input");if(await _append(g,F),g.setAttribute("type",i),g.setAttribute("id",u),g.setAttribute("name",u),g.setAttribute("placeholder",e),g.classList.add("form-control"),"file"!=i&&(g.value=s),"number"==i&&g.setAttribute("step","0.01"),null!=d&&void 0!=d&&g.setAttribute("data-aid",d),"file"==i?(a[l].length>0&&(g.setAttribute("data-allowed-file-extensions",a[l].join(" ").replace("image/","")),g.setAttribute("accept","."+a[l].join(",."))),""!=s&&(s=n.BaseUrl+s),g.setAttribute("data-default-file",s),g.classList.add("dropify"),g.classList.add("dynamicForm-dropify"),!0==n.inputDisable&&g.setAttribute("disabled","disabled"),t("#"+u).dropify(),!0==n.showDownloadButton&&t("#"+c).append('<center><a target="_blank" href="'+s+'" class="btn btn-float  btn-pink"><i class="fa fa-cloud-download"></i></a></center>')):!0==n.inputDisable&&g.setAttribute("disabled",!0),!1==n.inputDisable){let h=document.createElement("span");await _append(h,$),h.classList.add("input-remove"),h.innerHTML=n.RemoveButtonIcon,h.setAttribute("data-id",u)}let D=document.createElement("span");await _append(D,F),D.classList.add("errors"),D.classList.add("dyerrors"),D.setAttribute("id",u+"-err")},loadData=async t=>{if(null!=t&&void 0!=t.inputs){if(Array.isArray(t.inputs)){if(void 0!=t.inputs.length){let e=0;for(let i=0;i<t.inputs.length;i++){e=t.inputs[i];let n=0;void 0!=e.isRequired&&(n=e.isRequired),await add_input(e.name,e.type,e.dType,e.value,e.id,e.aid,n),a.InputName[a.InputName.length]=e.name}}}else alert("data not valid")}},validate=async e=>{let i=!0,n="",l="",s="",u="",d="";for(let r=0;r<a.inputs.length;r++)if(e==a.inputs[r].id){n=a.inputs[r].id,l=a.inputs[r].type,s=a.inputs[r].dType,u=a.inputs[r].name;let p=a.inputs[r].isRequired,o="";d=document.getElementById(a.inputs[r].id).value,"file"==l?(o=document.getElementById(a.inputs[r].id).getAttribute("data-default-file").toString().trim(),""==d&&""!=o&&(d=o)):o=d,t("#"+n+"-err").html(""),1==p&&""==d&&""==o?(t("#"+n+"-err").html(u+" is required"),i=!1):""!=d&&("date"==l?await is_Date(d)==!1&&(t("#"+n+"-err").html(u+" is not valid  Date"),i=!1):"number"==l?await is_Number(d)==!1&&(t("#"+n+"-err").html(u+" is not valid  number"),i=!1):"email"==l?await is_email(d)==!1&&(t("#"+n+"-err").html("E-Mail Address not valid"),i=!1):"url"==l?await is_Url(d)==!1&&(t("#"+n+"-err").html(u+" is not valid  url"),i=!1):"file"==l&&("Image"==s?await is_Images(d)==!1&&(t("#"+n+"-err").html("Image format not supported. "+a.Images.join(",")+" formats only accepted"),i=!1):"Pdf"==s?await is_PDF(d)==!1&&(t("#"+n+"-err").html("Document format not supported. "+a.PDF.join(",")+" format only accepted"),i=!1):"Douments"==s?await is_Documents(d)==!1&&(t("#"+n+"-err").html("Document format not supported. "+a.Documents.join(",")+" formats only accepted"),i=!1):"all"==s&&await is_AllDocuments(d)==!1&&(t("#"+n+"-err").html("Document format not supported. "+a.AllDocuments.join(",")+" formats only accepted"),i=!1)))}return i},validateAll=async()=>{t(".dyerrors").html("");let e=!0,i="",l="",s="",u="",d="";for(let r=0;r<a.inputs.length;r++){i=a.inputs[r].id,l=a.inputs[r].type,s=a.inputs[r].dType,u=a.inputs[r].name;let p=a.inputs[r].isRequired,o="";void 0!=document.getElementById(a.inputs[r].id)&&(d=document.getElementById(a.inputs[r].id).value,"file"==l?(o=document.getElementById(a.inputs[r].id).getAttribute("data-default-file").toString().trim(),""==d&&""!=o&&(d=o)):o=d,1==p&&""==d&&""==o?(t("#"+i+"-err").html(u+" is required"),e=!1):""!=d&&("date"==l?await is_Date(d)==!1&&(t("#"+i+"-err").html(u+" is not valid  Date"),e=!1):"number"==l?await is_Number(d)==!1&&(t("#"+i+"-err").html(u+" is not valid  number"),e=!1):"email"==l?await is_email(d)==!1&&(t("#"+i+"-err").html("E-Mail Address not valid"),e=!1):"url"==l?await is_Url(d)==!1&&(t("#"+i+"-err").html(u+" is not valid  url"),e=!1):"file"==l&&("Image"==s?await is_Images(d)==!1&&(t("#"+i+"-err").html("Image format not supported. "+a.Images.join(",")+" formats only accepted"),e=!1):"Pdf"==s?await is_PDF(d)==!1&&(t("#"+i+"-err").html("Document format not supported. "+a.PDF.join(",")+" format only accepted"),e=!1):"Douments"==s?await is_Documents(d)==!1&&(t("#"+i+"-err").html("Document format not supported. "+a.Documents.join(",")+" formats only accepted"),e=!1):"all"==s&&await is_AllDocuments(d)==!1&&(t("#"+i+"-err").html("Document format not supported. "+a.AllDocuments.join(",")+" formats only accepted"),e=!1))))}return n.validateStatus=e,e},t(document).on("keyup","input",function(){let e=t(this).attr("id");!0==n.isValidate&&validate(e)}),t(document).on("change","input",function(){let e=t(this).attr("id");!0==n.isValidate&&validate(e)}),t(document).on("click",".input-remove",function(){let e=t(this).attr("data-id"),i=t('label[for="'+e+'"]').html().toString().replace(' <span class="required"> * </span>',""),n=t("#"+e).attr("data-aid"),l=t("#"+e).attr("type"),s=[];for(let u=0;u<a.inputs.length;u++)a.inputs[u].id!=e&&(s[s.length]=a.inputs[u]);let d=[];for(let r=0;r<a.InputName.length;r++)a.InputName[r]!=i&&(d[d.length]=a.InputName[r]);a.inputs=s,a.InputName=d,void 0!=n&&""!=n&&(a.DeleteAIDs[a.DeleteAIDs.length]={AID:n,type:l}),t('span[data-id="'+e+'"]').parent().remove()}),t(document).on("change",".dynamicForm-dropify",function(){let e=t(this).attr("id");var i=document.getElementById(e);for(let n=0;n<a.inputs.length;n++)a.inputs[n].id==e&&(a.inputs[n].fileName=i.files[0].name,a.inputs[n].fileSize=i.files[0].size,a.inputs[n].fileType=i.files[0].type)}),t(document).on("click",".addMoreFields",function(){let t='<option value="">--Select Input Type--</option>';for(let e=0;e<n.InputTypes.length;e++)if("file"==n.InputTypes[e])for(let i=0;i<n.FileTypes.length;i++)t+='<option data-type="'+n.FileTypes[i]+'"  value="'+n.InputTypes[e]+'">'+n.FileTypes[i]+"</option>";else t+='<option value="'+n.InputTypes[e]+'">'+n.InputTypes[e]+"</option>";let l='<div class="row"><div class="col-sm-12" style="margin-top:20px"><div class="form-group"><label for="inputName">Name  <span class="required">*</span></label><input type="text" id="inputName" class="form-control"><span class="errors" id="inputName-err"></span></div></div><div class="col-sm-12" style="margin-top:20px"><div class="form-group"><label for="lstInputType">Input Type  <span class="required">*</span></label><select id="lstInputType" name="lstInputType" class="form-control" >'+t+'</select><span class="errors" id="lstInputType-err"></span></div></div></div><div class="row d-flex justify-content-center" style="margin-top:20px"><div class="col-5 d-flex justify-content-center"><div class="form-check"><input type="checkbox" checked class="form-check-input" id="chkisRequired"><label class="form-check-label" for="chkisRequired">is Required</label></div></div><div class="col-5 d-none justify-content-center" style="display:none"><div class="form-check"><input type="checkbox"  class="form-check-input" id="chkisFixed"><label class="form-check-label" for="chkisFixed">is Fixed</label></div></div></div><div class="row"><div class="bt col-sm-12 text-right" style="margin-top:20px"><button class="btn btn-light" style="margin:7px" id="btCancel">Cancel</button><button class="bt btn btn-outline-success" style="margin:7px" id="btAdd">Add</button></div></div>';a.dialog=bootbox.dialog({title:"",closeButton:!0,message:l,buttons:{}})}),t(document).on("click","#btAdd",function(){if(null!=a.dialog){let e=!0,i=0,l=t("#chkisRequired").prop("checked")?1:0,s=t("#lstInputType").val(),u=t("#lstInputType option:selected").attr("data-Type"),d=t("#inputName").val();!0==t("#chkisRequired").prop("checked")&&(i=1),""==d?(t("#inputName-err").html("name is required"),e=!1):d.length<3?(t("#inputName-err").html("name must be at least 3 characters"),e=!1):d.length>50?(t("#inputName-err").html("name not be greater than 50 characters"),e=!1):!1==n.allowDuplicateNames&&t.inArray(d,a.InputName)>=0?(t("#inputName-err").html("Name is already taken"),e=!1):t("#inputName-err").html(""),""==s?(t("#lstInputType-err").html("please select input type"),e=!1):0>t.inArray(s,n.InputTypes)?(t("#lstInputType-err").html("input type not valid"),e=!1):t("#lstInputType-err").html(""),!0==e&&(t("#lstInputType-err").html(""),a.dialog.modal("hide"),a.dialog=null,a.InputName[a.InputName.length]=d,add_input(d,s,u,"",null,null,i,l))}}),t(document).on("click","#btCancel",function(){null!=a.dialog&&(a.dialog.modal("hide"),a.dialog=null)}),(init=async()=>{await _getFileTypes(),a.parentDiv=await createDiv(await uniqid("div"),"dynamic-Form",i),a.inputDiv=await createDiv(await uniqid("div"),[],a.parentDiv),await a.inputDiv.classList.add("row"),await a.inputDiv.classList.add("input-Form"),await a.inputDiv.classList.add("text-left"),a.addButton=await add_button(a.parentDiv),setTimeout(async function(){console.log(n.Data),await loadData(n.Data)},0)})(),{getVersion:async()=>a.Version,async drawData(t){await loadData(t)},async getFieldID(){let t=[];for(let e=0;e<a.inputs.length;e++)t[t.length]=a.inputs[e].id;return t},async getFormData(){let t=new FormData,e=[],i=[];for(let n=0;n<a.inputs.length;n++)void 0!=document.getElementById(a.inputs[n].id)&&("file"!=a.inputs[n].type?a.inputs[n].value=document.getElementById(a.inputs[n].id).value:""!=document.getElementById(a.inputs[n].id).value&&t.append(a.inputs[n].id,document.getElementById(a.inputs[n].id).files[0]),i[i.length]=parseInt(a.inputs[n].fileSize),e[e.length]={name:a.inputs[n].name,value:a.inputs[n].value,type:a.inputs[n].type,aid:a.inputs[n].aid,fileName:a.inputs[n].fileName,fileType:a.inputs[n].fileType,fileSize:a.inputs[n].fileSize});return t},async getData(){let t=new FormData,e=[],i=[],l=[];for(let s=0;s<a.inputs.length;s++)if(void 0!=document.getElementById(a.inputs[s].id)){"file"!=a.inputs[s].type?a.inputs[s].value=document.getElementById(a.inputs[s].id).value:""!=document.getElementById(a.inputs[s].id).value?t.append(a.inputs[s].id,document.getElementById(a.inputs[s].id).files[0]):""!=document.getElementById(a.inputs[s].id).getAttribute("data-default-file")&&(a.inputs[s].value=document.getElementById(a.inputs[s].id).getAttribute("data-default-file").replace(n.BaseUrl,"")),i[i.length]=parseInt(a.inputs[s].fileSize);let u={name:a.inputs[s].name,ColName:a.inputs[s].ColName,value:a.inputs[s].value,isRequired:a.inputs[s].isRequired,isFixed:a.inputs[s].isFixed,type:a.inputs[s].type,aid:a.inputs[s].aid,fileName:a.inputs[s].fileName,fileType:a.inputs[s].fileType,fileSize:a.inputs[s].fileSize};e[e.length]=u,1==a.inputs[s].isFixed&&l.push(u)}return{inputs:a.inputs,data:e,DeletedItems:a.DeleteAIDs,fileSize:i,validateStatus:n.validateStatus,fixedFields:l}},getValidateStatus:async()=>n.validateStatus,Validate:async()=>validateAll()}}}(jQuery);